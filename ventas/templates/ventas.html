{% extends "base_v.html" %}
{% load static %}

{% block content %}
<head>
    <link rel="stylesheet" href="reset.css">
    <link href="https://fonts.googleapis.com/css2?family=Magra&display=swap" rel="stylesheet">
    <style>
        /* Estilos de la tabla */
        /* Estilos del contenedor de la tabla */
        .contenido {
            width: 90%;
            margin: 0 auto;
            text-align: center;
            font-family: 'Magra', sans-serif;
        }

        .contenido h1 {
            font-size: 35px;
        }

        .contenedor_buscar {
            display: flex;
            margin-top: 60px;
        }

        .contenedor_buscar img {
            width: 38px;
            height: 35px;
            margin: 0 0 0 10px;
        }

        .buscar {
            width: 20%;
            height: 40px;
            background-color: #E6AF2E;
            padding: 0 14px;
            border-radius: 20px;
            margin-right: 10px;
            margin-bottom: 20px;
        }

        #subtotal-container {
            display: flex;
            margin-left: 50%;
        }

        #subtotal-container p {
            margin-right: 10px;
            font-size: 16px;
            margin-top: 10px;
        }

        #subtotal {
            border: 1px solid;
            text-align: center;
            font-size: 30px;
            border-radius: 20px;
        }

        input {
            border: 0;
            text-align: center;
            font-size: 30px;
        }

        input::placeholder {
            font-weight: bold;
            color: black;
            /* Cambiar el color del placeholder */
            opacity: .8;
        }

        #tabla-container {
            width: 70%;
            margin: 0 auto;
            /* Centrar horizontalmente */
        }

        /* Estilos de la tabla */
        #tabla-productos {
            width: 100%;
            border-collapse: collapse;
        }

        #tabla-productos th {
            background-color: #A3320B;
            color: white;
            font-size: 16px;
        }

        #tabla-productos td {
            font-size: 16px;
        }

        #tabla-productos th,
        #tabla-productos td {
            border-top: 1px solid black;
            padding: 8px 2px;
            text-align: center;
        }

        .acciones {
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .imagenes {
            width: 30px;
            height: 30px;
        }

        .btnpago {
            margin-top: 60px;
        }

        .pago {
            font-size: 16px;
            padding: 12px 60px;
            border-radius: 20px;
            border: 0;
            width: 200px;
            background-color: #E6AF2E;
            cursor: pointer;
            color: black;
        }
    </style>
</head>

<body>
    <main>
        <div class="contenido">
            <div class="contenedor_buscar">
                <img src="/media/buscar.png" alt="">
                <div class="buscar">
                    <input id="buscador" type="text" placeholder="Buscar">
                </div>
                <div id="subtotal-container">
                    <p class="cont">Total</p>
                    <input type="text" id="subtotal" value="{{ subtotal }}" readonly>
                </div>
            </div>
            <div id="tabla-container">
                <table id="tabla-productos">
                    <thead>
                        <tr>
                            <th style="width: 25%;">Producto</th>
                            <th style="width: 20%;">Precio</th>
                            <th style="width: 20%;">Cantidad</th>
                            <th style="width: 25%;">Subtotal</th>
                            <th style="width: 10%;"></th>
                        </tr>
                    </thead>
                    <tbody id="tabla-body">
                        <!-- Filas de productos añadidos al carrito -->
                    </tbody>
                </table>
            </div>
            <p class="btnpago"><a href="/pago/?subtotal={{ subtotal }}" class="pago">Elegir forma de pago</a></p>
        </div>
    </main>
</body>
{% endblock %}

{% block js %}
<script>
    // Resto del código JavaScript

    const buscador = document.querySelector('#buscador');
    const tablaProductos = document.querySelector('#tabla-productos tbody');
    const subtotalInput = document.querySelector('#subtotal');

    buscador.addEventListener('input', () => {
        const query = buscador.value.trim();
        if (query.length >= 3) {
            fetch(`/buscar_productos/?q=${query}`)
                .then(response => response.json())
                .then(data => {
                    const nuevosProductos = data.productos.filter(producto => !productoEnTabla(producto.id));
                    nuevosProductos.forEach(producto => {
                        agregarProductoTabla(producto);
                    });
                    calcularTotal();
                });
        }
    });

    buscador.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
            event.preventDefault();
            const query = buscador.value.trim();
            if (query.length >= 3) {
                fetch(`/buscar_productos/?q=${query}`)
                    .then(response => response.json())
                    .then(data => {
                        const nuevosProductos = data.productos.filter(producto => !productoEnTabla(producto.id));
                        nuevosProductos.forEach(producto => {
                            agregarProductoTabla(producto);
                        });
                        calcularTotal();
                    });
                buscador.value = '';
            }
        }
    });

    // Obtener los productos del carrito desde el servidor
    function obtener_productos_del_carrito() {
        return fetch('/obtener_productos_del_carrito/')
            .then(response => response.json())
            .then(data => data.productos);
    }

    tablaProductos.addEventListener('click', (event) => {
        if (event.target.classList.contains('btn-eliminar')) {
            const fila = event.target.closest('tr');
            const idProducto = fila.querySelector('.id-producto').value;
            fila.remove();
            calcularTotal();
        }
    });

    tablaProductos.addEventListener('input', (event) => {
        if (event.target.classList.contains('cantidad')) {
            const cantidadInput = event.target;
            const fila = cantidadInput.closest('tr');
            const precio = parseFloat(fila.querySelector('td:nth-child(2)').textContent.slice(1));
            const cantidad = parseInt(cantidadInput.value);
            const subtotal = fila.querySelector('td:nth-child(4)');
            subtotal.textContent = `$${(precio * cantidad).toFixed(2)}`;
            calcularTotal();
        }
    });

    function agregarProductoTabla(producto) {
        const fila = document.createElement('tr');
        fila.innerHTML = `
            <td>${producto.nombre}</td>
            <td>$${producto.precio.toFixed(2)}</td>
            <td><input type="number" class="cantidad" value="1" min="1"></td>
            <td>$${producto.precio.toFixed(2)}</td>
            <td><button class="btn-eliminar">Eliminar</button></td>
            <input type="hidden" class="id-producto" value="${producto.id}">
        `;
        tablaProductos.appendChild(fila);
    }

    function productoEnTabla(idProducto) {
        const filas = tablaProductos.querySelectorAll('tr');
        for (let i = 0; i < filas.length; i++) {
            const id = filas[i].querySelector('.id-producto').value;
            if (id === idProducto) {
                return true;
            }
        }
        return false;
    }

    function calcularTotal() {
        const filas = tablaProductos.querySelectorAll('tr');
        let total = 0;
        filas.forEach(fila => {
            const precio = parseFloat(fila.querySelector('td:nth-child(2)').textContent.slice(1));
            const cantidad = parseInt(fila.querySelector('.cantidad').value);
            total += precio * cantidad;
        });
        subtotalInput.value = total.toFixed(2);
    }

</script>
{% endblock js %}


