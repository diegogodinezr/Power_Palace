{% extends "base_v.html" %}
{% load static %}

{% block content %}

<head>
    <link href="https://fonts.googleapis.com/css2?family=Magra&display=swap" rel="stylesheet">
    <style>
        /* Estilos de la tabla */
        /* Estilos del contenedor de la tabla */
        .contenido {
            width: 90%;
            margin: 0 auto;
            text-align: center;
            font-family: 'Magra', sans-serif;

        }

        .contenido h1 {
            font-size: 35px;
        }

        .contenedor_buscar {
            display: flex;
        }

        .contenedor_buscar img {
            width: 38px;
            height: 35px;
            margin: 0 0 0 10px;
        }

        .buscar {
            width: 20%;
            height: 40px;
            background-color: #E6AF2E;
            padding: 0 14px;
            border-radius: 20px;
            margin-bottom: 50px;
        }

        input {
            border: 0;
            text-align: center;
        }

        input::placeholder {
            font-weight: bold;
            color: black;
            /* Cambiar el color del placeholder */
            opacity: .8;
        }

        #tabla-container {
            width: 100%;
            margin: 0 auto;
            /* Centrar horizontalmente */
        }

        /* Estilos de la tabla */
        #tabla-productos {
            width: 100%;
            border-collapse: collapse;
        }

        #tabla-productos th {
            background-color: #A3320B;
            color: white;
            font-size: 16px;
        }

        #tabla-productos td {
            font-size: 16px;
        }

        #tabla-productos th,
        #tabla-productos td {
            border: 1px solid black;
            padding: 8px 2px;
            text-align: center;
        }

        .acciones {
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .imagenes {
            width: 20px;
            height: 20px;

        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.2);
            /* Fondo oscuro semitransparente */
            z-index: 9999;
            /* Asegurarse de que el modal esté por encima del resto del contenido */
        }

        .form_contenido {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 71vh;
            background-color: white;
            font-family: 'Magra', sans-serif;
        }

        #contenedor-formulario {
            background-color: #791F00;
            padding: 25px 0;
            border-radius: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            max-width: 350px;
            width: 100%;
            margin: 0 auto;
            /* Agregar esta línea */
            text-align: center;
        }

        #formulario-producto {
            display: block;
            margin: 0 auto;
            max-width: 220px;
            /* Agregar esta línea para limitar el ancho del formulario */
            align-items: center;
        }

        .ingresar,
        textarea {
            display: block !important;
            margin: 0 0 25px !important;
            width: 100% !important;
            /* Modificar esta línea para que los inputs y textarea ocupen el ancho completo del formulario */
            height: 25px !important;
            background-color: rgba(255, 255, 255, 0.3) !important;
            /* Cambiar opacity por rgba */
            color: #FFFFFF !important;
            /* Establecer el color del texto en blanco */
            border-radius: 30px !important;
            text-align: center !important;
            border: black !important;
            resize: none;
        }

        .ingresar::placeholder {
            color: white;
            /* Cambiar el color del placeholder */
            opacity: .5;
        }

        textarea::placeholder {
            color: white;
            /* Cambiar el color del placeholder */
            opacity: .5;
        }

        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        button[type="submit"] {
            padding: 8px 16px;
            background-color: white;
            color: black;
            border: none;
            cursor: pointer;
            border-radius: 30px;
            width: 100px;
        }

        .modal_eliminar {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.2);
            /* Fondo oscuro semitransparente */
            z-index: 9998;
            /* Asegurarse de que el modal esté por encima del resto del contenido */
        }

        .modal-contenido {
            font-family: 'Magra', sans-serif !important;
            width: 340px !important;
            height: 120px !important;
            background-color: #791F00 !important;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1) !important;
            position: absolute !important;
            top: 50% !important;
            /* Centrar verticalmente */
            left: 50% !important;
            /* Centrar horizontalmente */
            transform: translate(-50%, -50%) !important;
            /* Centrar con transform */
            padding: 20px !important;
            text-align: center !important;
            display: flex !important;
            flex-direction: column !important;
            justify-content: center !important;
            align-items: center !important;
            border: solid black !important;
        }

        .modal-contenido p {
            color: white;
            font-size: 15px;
            margin-top: 50px;
        }

        .modal-cerrar {
            width: 100%;
            height: 35px;
            display: flex;
            justify-content: flex-end;
            /* Alinear el contenido al final del div */
            background-color: white;
            position: absolute;
            /* Establecer posición absoluta */
            top: 0;
            /* Anclar el div en la parte superior del modal */
            left: 0;
            /* Anclar el div a la izquierda del modal */
            padding: 2px;
            /* Añadir un espacio interno de 10px */
            box-sizing: border-box;
            /* Incluir el padding en el ancho total del div */
            border-bottom: solid black;
        }


        .modal-cerrar img {
            width: 40px;
            height: 30px;
            cursor: pointer;

        }

        .botones-modal {
            display: inline-block;
            border-radius: 10px;
            background-color: white;
            color: black;
            margin-bottom: 15px;
            padding: 4px 6px;
            border: 0;
        }
    </style>
</head>

<body>
    <main>
        <div class="contenido">
            <h1>Inventario</h1>
            <div class="contenedor_buscar">
                <img src="/media/buscar.png" alt="">
                <div class="buscar">
                    <input id="buscador" type="text" placeholder="Buscar">
                </div>
            </div>
            <div id="tabla-container">
                <table id="tabla-productos">
                    <thead>
                        <tr>
                            <th style="width: 10%;">ID</th>
                            <th style="width: 15%;">Nombre</th>
                            <th style="width: 20%;">Descripción</th>
                            <th style="width: 15%;">Categoría</th>
                            <th style="width: 10%;">Existencia</th>
                            <th style="width: 10%;">Precio </th>
                            <th style="width: 10%;"></th>
                            <th style="width: 10%;"></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for producto in productos %}
                        <tr>
                            <td>{{ producto.id }}</td>
                            <td>{{ producto.nombre }}</td>
                            <td>{{ producto.descripcion }}</td>
                            <td>{{ producto.categoria }}</td>
                            <td>{{ producto.cantidad }}</td>
                            <td>{{ producto.precio }}</td>
                            <td>
                                <button class="editar" data-id="{{ producto.id }}">
                                    <img class="imagenes" src="/media/modificar_tabla.svg" alt=""> Editar
                                </button>
                            </td>
                            <td>
                                <div class="acciones">
                                    <a class="eliminar" data-id="{{ producto.id }}"><img class="imagenes"
                                            src="/media/eliminar_tablas.png" alt=""> Eliminar</a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </main>
    <div id="modal_eliminar" class="modal_eliminar">
        <div class="modal-contenido">
            <div class="modal-cerrar">
                <img src="/media/cerrar.png" id="miImagen" alt="cerrar">
            </div>
            <form id="formulario-eliminar" method="post" action="/eliminar_producto/">
                {% csrf_token %}
                <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                <input type="hidden" name="id_producto" id="producto_id_eliminar" value="">
                <button type="submit" id="finalizar_btn">Eliminar</button>
            </form>
        </div>

    </div>
    <div id="modal" class="modal">
        <div class=form_contenido>
            <div style="width: 100%; text-align: center;">
                <h1 style="font-size: 35px; padding-bottom: 5px;">Modificar producto</h1>
                <div id="contenedor-formulario">
                    <form id="formulario-producto" method="post" action="/updateproducto/" enctype="multipart/form-data">
                        {% csrf_token %}
                        <input class="ingresar" type="text" id="id_producto" name="id_producto" required
                            placeholder="ID producto">
                        <input class="ingresar" type="text" id="nombre" name="nombre" required placeholder="Nombre">
                        <input class="ingresar" type="number" id="precio" name="precio" required placeholder="Precio">
                        <input class="ingresar" type="number" id="cantidad" name="cantidad" required
                            placeholder="Cantidad">
                        <textarea id="descripcion" name="descripcion" required placeholder="Descripción"></textarea>
                        <input class="ingresar" type="text" id="categoria" name="categoria" required
                            placeholder="Categoría">
                        <input type="hidden" id="producto_id" name="producto_id" value="">
                        <button type="submit" id="cerrarModalBtn">Guardar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</body>

<script>
    //AREA DE MODIFICAR PRODUCTO
    // Función para abrir el modal de edición
    function abrirModalEditar(event) {
        event.preventDefault();
        const productoId = event.target.dataset.id;
        console.log('Producto ID:', productoId);

        // Realizar una solicitud AJAX para obtener el producto por su ID
        const xhr = new XMLHttpRequest();
        xhr.open("GET", `/obtener_producto/${productoId}/`, true);
        xhr.onreadystatechange = function () {
            if (xhr.readyState === XMLHttpRequest.DONE) {
                if (xhr.status === 200) {
                    const producto = JSON.parse(xhr.responseText);
                    console.log('Producto:', producto);
                    if (producto && producto.producto) {
                        const formularioProducto = document.getElementById("formulario-producto");
                        formularioProducto.id_producto.value = producto.producto.id;
                        formularioProducto.nombre.value = producto.producto.nombre;
                        formularioProducto.precio.value = producto.producto.precio;
                        formularioProducto.cantidad.value = producto.producto.cantidad;
                        formularioProducto.descripcion.value = producto.producto.descripcion;
                        formularioProducto.categoria.value = producto.producto.categoria;

                        const modal = document.getElementById("modal");
                        modal.style.display = "block";
                    } else {
                        console.error('No se encontró el producto');
                    }
                } else {
                    console.error('Error al obtener el producto');
                }
            }
        };
        xhr.send();
    }





    // Función para cerrar el modal de edición
    function cerrarModalEditar() {
        const modal = document.getElementById("modal");
        modal.style.display = "none";
    }

    // Función para actualizar el producto
    function actualizarProducto() {
        const formularioProducto = document.getElementById("formulario-producto");
        const formData = new FormData(formularioProducto);
        const csrfToken = document.querySelector("[name=csrfmiddlewaretoken]").value;
        const productoId = formularioProducto.id_producto.value; // Obtener el id del producto del campo "id_producto"

        // Realizar una petición AJAX para actualizar el producto
        const xhr = new XMLHttpRequest();
        
        xhr.open("POST", `/updateproducto/`, true);
        // Pasar el id en la URL
        xhr.setRequestHeader("X-CSRFToken", csrfToken);

        xhr.onreadystatechange = function () {
            if (xhr.readyState === XMLHttpRequest.DONE) {
                if (xhr.status === 200) {
                    // Producto actualizado con éxito
                    cerrarModalEditar();
                    // Puedes realizar cualquier otra acción necesaria después de actualizar el producto
                } else {
                    // Error al actualizar el producto
                    console.error("Error al actualizar el producto");
                }
            }
        };

        xhr.send(formData);
    }


    // Agregar eventos a los botones relevantes
    document.addEventListener("DOMContentLoaded", function () {
        const editarButtons = document.querySelectorAll(".editar");
        const guardarBtn = document.querySelector("#formulario-producto button[type='submit']");
        const cerrarModalBtn = document.querySelector("#cerrarModalBtn");

        editarButtons.forEach(function (button) {
            button.addEventListener("click", abrirModalEditar);
        });

        guardarBtn.addEventListener("click", actualizarProducto);
        cerrarModalBtn.addEventListener("click", cerrarModalEditar);
    });







    //AREA DE ELIMINAR PRODUCTO
    // Función para abrir el modal de eliminación
    function abrirModalEliminar(event) {
        event.preventDefault();
        const productoId = event.target.dataset.id;
        console.log(productoId); // Agregado para verificar el valor del ID del producto
        const modalEliminar = document.getElementById("modal_eliminar");
        modalEliminar.style.display = "block";
        // Guardar el id del producto en un campo oculto dentro del modal
        const productoIdInput = modalEliminar.querySelector("#producto_id_eliminar");
        productoIdInput.value = productoId;
    }

    // Función para cerrar el modal de eliminación
    function cerrarModalEliminar() {
        const modalEliminar = document.getElementById("modal_eliminar");
        modalEliminar.style.display = "none";
    }

    // Función para eliminar el producto
    // Función para eliminar el producto
    function eliminarProducto() {
        const productoId = obtenerIdDelProducto(); // Obtener el ID del producto de alguna manera
        const productoIdInput = document.querySelector("#producto_id_eliminar");
        const modalEliminar = document.getElementById("modal_eliminar");

        productoIdInput.value = productoId;
        // Crear un objeto FormData para enviar los datos del formulario
        const formData = new FormData();
        formData.append("id_producto", productoId);

        // Realizar una petición AJAX para eliminar el producto
        const xhr = new XMLHttpRequest();
        xhr.open("POST", "/eliminar_producto/", true);
        xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");  // Agrega esta línea para incluir el token CSRF

        xhr.onreadystatechange = function () {
            if (xhr.readyState === XMLHttpRequest.DONE) {
                if (xhr.status === 200) {
                    // Producto eliminado con éxito
                    cerrarModalEliminar();
                    // Puedes realizar cualquier otra acción necesaria después de eliminar el producto
                } else {
                    // Error al eliminar el producto
                    console.error("Error al eliminar el producto");
                }
            }
        };

        xhr.send(formData);
    }

    // Agregar eventos a los botones y enlaces relevantes
    document.addEventListener("DOMContentLoaded", function () {
        const eliminarLinks = document.querySelectorAll(".eliminar");
        const finalizarBtn = document.querySelector("#finalizar_btn");
        const cerrarModalBtn = document.querySelector("#miImagen");

        eliminarLinks.forEach(function (link) {
            link.addEventListener("click", abrirModalEliminar);
        });

        finalizarBtn.addEventListener("click", eliminarProducto);
        cerrarModalBtn.addEventListener("click", cerrarModalEliminar);
    });
</script>

{% endblock %}